# MarkerUtils.kt

> **File**: `app/src/main/java/net/vonforst/evmap/ui/MarkerUtils.kt`  
> **Purpose**: Manages all map markers (charging station pins, clusters, search results) including range-based filtering.

---

## What Is This File?

`MarkerUtils` is the **central manager for all pins on the map**. Every time you see a colored marker on the map representing a charging station â€” this file is responsible for:

1. **Adding markers** when new stations come into view
2. **Removing markers** when stations go out of view
3. **Hiding markers** when they're outside the user's battery range
4. **Animating markers** with smooth appear/disappear effects
5. **Generating icons** with the right color, size, and style
6. **Clustering** nearby stations into a single "5+" bubble at low zoom

---

## Class Structure

```kotlin
class MarkerManager(
    private val map: AnyMap,                    // The map to draw on
    private val lifecycle: LifecycleOwner,       // For coroutine scoping
    private val chargerIconGenerator: ...,        // Creates marker bitmaps
    private val clusterIconGenerator: ...,        // Creates cluster bitmaps
    private val prefs: PreferenceDataSource,      // User preferences
    private val mini: Boolean = false             // Small markers mode
)
```

---

## Key Properties (What You Can Set)

| Property | Type | Purpose |
|----------|------|---------|
| `chargepoints` | `List<ChargepointListItem>` | Full list of stations from the API |
| `highlighedCharger` | `ChargeLocation?` | Currently selected/highlighted station |
| `filteredConnectors` | `Set<String>?` | Connector types the user wants (e.g., CCS, Type 2) |
| `favorites` | `Set<Long>` | IDs of user's favorite stations (shown with â­) |
| `searchResult` | `PlaceWithBounds?` | Place search result marker |
| `rangeFilterKm` | `Float` | Range filter distance in km (0 = disabled) |
| `userLocation` | `LatLng?` | User's current GPS position |

When you set any of these properties, the markers **automatically update** (via the setter calling `updateChargepoints()` or `updateChargerIcons()`).

---

## How Range Filtering Works

This is one of the most important features. When the user enters their vehicle details and applies a range filter:

```
User sets rangeFilterKm = 200.0 and userLocation = (17.385, 78.487)
         â”‚
         â–¼
isInRange() is called for EACH charging station:
         â”‚
         â”œâ”€ Station A is 50 km away  â†’ IN RANGE â†’ Show marker âœ…
         â”œâ”€ Station B is 150 km away â†’ IN RANGE â†’ Show marker âœ…
         â”œâ”€ Station C is 250 km away â†’ OUT OF RANGE â†’ HIDE marker âŒ
         â””â”€ Station D is 300 km away â†’ OUT OF RANGE â†’ HIDE marker âŒ
```

### The `isInRange()` Function

```kotlin
private fun isInRange(charger: ChargeLocation): Boolean {
    if (rangeFilterKm <= 0 || userLocation == null) return true  // No filter = show all
    val dist = distanceBetween(
        userLocation!!.latitude, userLocation!!.longitude,
        charger.coordinates.lat, charger.coordinates.lng
    ) / 1000.0  // Convert meters to km
    return dist <= rangeFilterKm
}
```

> **Note**: This uses straight-line (Haversine) distance, not driving distance. A station 200 km away by road might only be 150 km as-the-crow-flies.

---

## How Markers Are Updated

### `updateChargepoints()` â€” Add/Remove Markers

```
Called when: chargepoints list changes, range filter changes, 
            user location changes
         â”‚
         â–¼
1. Filter chargepoints to only in-range stations
         â”‚
         â–¼
2. Remove markers for stations that:
   - Disappeared from the API response
   - Are now out of range
   (with smooth animation if visible on screen)
         â”‚
         â–¼
3. Add new markers for stations that:
   - Are newly in range
   - Are newly loaded from the API
   (with smooth pop-in animation)
```

### `updateChargerIcons()` â€” Update Existing Marker Styles

```
Called when: connector filter changes, favorites change, 
            highlighted charger changes
         â”‚
         â–¼
For each existing marker on the map:
  - Regenerate the icon with correct color/style
  - Update the marker's icon bitmap
```

---

## Marker Icon System

Each marker icon is generated by `makeIcon()`:

```kotlin
private fun makeIcon(charger: ChargeLocation, scale: Float = 1f): BitmapDescriptor? {
    return chargerIconGenerator.getBitmapDescriptor(
        tint = getMarkerTint(charger, filteredConnectors),  // Color
        scale = scale,                                       // Size
        alpha = 255,                                         // Full opacity
        highlight = charger.id == highlightedCharger?.id,    // Selected?
        fault = charger.faultReport != null,                 // Has faults?
        multi = charger.isMulti(filteredConnectors),         // Multiple connectors?
        fav = charger.id in favorites,                       // Favorite?
        mini = mini                                          // Small mode?
    )
}
```

### Marker Colors (Tints)

| Color | Meaning |
|-------|---------|
| ğŸŸ¢ Green | Available, high power |
| ğŸŸ¡ Yellow/Amber | Available, medium power |
| ğŸ”´ Red | Faulted/offline |
| â­ Star overlay | User's favorite |
| ğŸ”µ Blue highlight | Currently selected |

---

## Marker Animation

Markers don't just pop in and out â€” they animate smoothly:

```
Adding a marker:    Marker appears with a scale-up/bounce animation
Removing a marker:  Marker shrinks/fades before being deleted
```

This is handled by the `animator` object and the `animateMarker()` function.

---

## Clustering

When zoomed out, nearby stations merge into cluster bubbles:

```
Zoom Level 15 (close):  Individual markers visible
                         ğŸ“ ğŸ“ ğŸ“ ğŸ“ ğŸ“

Zoom Level 10 (medium): Some clustering
                         ğŸ“ ğŸ“ â‘¢ ğŸ“

Zoom Level 5 (far):     Heavy clustering
                         â‘« â‘§ â‘¤
```

Cluster markers show the **count** of stations in that area and are managed separately from individual charger markers.

---

## How It Connects to Other Files

```
MarkerUtils.kt
    â”‚
    â”œâ”€â”€â—€ MapFragment.kt          â€” Creates MarkerManager, sets chargepoints,
    â”‚                               range filter, user location
    â”‚
    â”œâ”€â”€â—€ VehicleInputFragment.kt â€” Passes rangeFilterKm back to MapFragment
    â”‚                               which updates MarkerManager.rangeFilterKm
    â”‚
    â”œâ”€â”€â–¶ IconGenerators.kt        â€” Generates the actual bitmap images for markers
    â”‚
    â”œâ”€â”€â–¶ ChargersModel.kt         â€” Uses ChargeLocation data to position markers
    â”‚
    â””â”€â”€â–¶ LocationUtils.kt         â€” distanceBetween() for range calculations
```

---

## Key Design Decisions

1. **Hide, don't dim**: Out-of-range stations are completely **removed from the map**, not just made transparent. This keeps the map clean and avoids confusion.

2. **Animated transitions**: Markers smoothly appear/disappear rather than blinking in/out, making the map feel polished.

3. **BiMap for marker tracking**: Uses a `HashBiMap<Marker, ChargeLocation>` to efficiently look up markers by charger or charger by marker (bidirectional).

4. **Lazy icon updates**: Icons are only regenerated when something changes (filter, favorite, highlight), not on every frame.
